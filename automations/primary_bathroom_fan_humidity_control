alias: Primary Bathroom Fan - Humidity Control
description: Auto control fan based on humidity spike or high level
triggers:
  - entity_id:
      - sensor.zse44_02_humidity
    above: 65
    id: high_humidity
    trigger: numeric_state
  - entity_id:
      - sensor.primary_bathroom_humidity_dh_dt
    above: 1.5
    id: humidity_spike
    trigger: numeric_state
conditions:
  - condition: state
    entity_id: timer.bathroom_fan_timer
    state: idle
    enabled: false
actions:
  - action: input_boolean.turn_on
    metadata: {}
    target:
      entity_id: input_boolean.primary_bathroom_humidity_fan_active
    data: {}
  - target:
      entity_id:
        - switch.hpr_01
    action: switch.turn_on
    data: {}
    enabled: false
  - action: fan.turn_on
    target:
      entity_id:
        - fan.double_switch
  - data:
      value: "{{ states('sensor.bathroom_humidity_baseline') | float + 3 }}"
    action: input_number.set_value
    target:
      entity_id: input_number.primary_bathroom_humidity_target
  - wait_template: |
      {{ states('sensor.bathroom_humidity') | float(100) <= 
         states('input_number.bathroom_humidity_target') | float(100) }}
    timeout: "02:00:00"
    continue_on_timeout: true
  - delay:
      hours: 0
      minutes: 10
      seconds: 0
      milliseconds: 0
  - action: input_boolean.turn_off
    metadata: {}
    target:
      entity_id: input_boolean.primary_bathroom_humidity_fan_active
    data: {}
  - condition: state
    entity_id: timer.bathroom_fan_timer
    state: idle
  - action: switch.turn_off
    data: {}
    target:
      entity_id: switch.hpr_01
    enabled: false
  - action: fan.turn_off
    data: {}
    target:
      entity_id: fan.double_switch
mode: restart
